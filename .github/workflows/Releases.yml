name: Release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (如 1.0.0)'
        required: true
        type: string
      build_pyappify:
        description: '使用 PyAppify 打包'
        required: false
        type: boolean
        default: true
      build_nuitka:
        description: '使用 Nuitka 打包'
        required: false
        type: boolean
        default: false
      build_pyinstaller:
        description: '使用 PyInstaller 打包'
        required: false
        type: boolean
        default: false
      prerelease:
        description: '预发布版本'
        required: false
        type: boolean
        default: false

jobs:
  build-pyappify:
    if: inputs.build_pyappify
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build with PyAppify
        uses: ok-oldking/pyappify-action@master

      - name: Upload PyAppify Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DUANJU-PyAppify-${{ inputs.version }}
          path: pyappify_dist/*-release-setup.exe

  build-nuitka:
    if: inputs.build_nuitka
    uses: ./.github/workflows/Nuitka.yml
    with:
      version: ${{ inputs.version }}

  build-pyinstaller:
    if: inputs.build_pyinstaller
    uses: ./.github/workflows/PyInstaller.yml
    with:
      version: ${{ inputs.version }}

  release:
    needs: [build-pyappify, build-nuitka, build-pyinstaller]
    if: always() && (needs.build-pyappify.result == 'success' || needs.build-nuitka.result == 'success' || needs.build-pyinstaller.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Download PyAppify artifact
        if: inputs.build_pyappify && needs.build-pyappify.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: DUANJU-PyAppify-${{ inputs.version }}
          path: dist/pyappify

      - name: Download Nuitka artifact
        if: inputs.build_nuitka && needs.build-nuitka.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: Duanju-Nuitka-${{ inputs.version }}
          path: dist/nuitka

      - name: Download PyInstaller artifact
        if: inputs.build_pyinstaller && needs.build-pyinstaller.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: Duanju-PyInstaller-${{ inputs.version }}
          path: dist/pyinstaller

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          body: |
            ## 下载说明
            - **PyAppify**: 完整安装包
            - **Nuitka**: 单文件可执行程序，性能优化
            - **PyInstaller**: 单文件可执行程序，快速构建

            ## 源码运行
            ```bash
            git clone -b main https://github.com/GamblerIX/DUANJU
            pip install -r requirements.txt
            python main.py
            ```

            Debug 版本请切换到 dev 分支：`git checkout dev`

            ## Termux (Android)
            ```bash
            curl -sL https://gitee.com/GamblerIX/DUANJU/raw/Termux/install.sh | bash
            ```
          files: |
            dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
