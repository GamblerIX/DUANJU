name: Release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (如 1.0.0)'
        required: true
        type: string
      build_tool:
        description: '打包工具'
        required: true
        type: choice
        options:
          - PyAppify
          - Nuitka
          - PyInstaller
        default: 'PyAppify'
      prerelease:
        description: '预发布版本'
        required: false
        type: boolean
        default: false

jobs:
  build-pyappify:
    if: inputs.build_tool == 'PyAppify'
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Release build
        run: |
          Copy-Item -Path "Release/pyappify.yml" -Destination "pyappify.yml" -Force
          Copy-Item -Path "Release/main.py" -Destination "main.py" -Force
          Copy-Item -Path "Release/requirements.txt" -Destination "requirements.txt" -Force
          if (Test-Path "Release/src") { Copy-Item -Path "Release/src" -Destination "src" -Recurse -Force }
          if (Test-Path "Release/assets") { Copy-Item -Path "Release/assets" -Destination "assets" -Recurse -Force }

      - name: Build with PyAppify
        uses: ok-oldking/pyappify-action@master

      - name: Upload PyAppify Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DUANJU-PyAppify-${{ inputs.version }}
          path: pyappify_dist/*

  build-nuitka:
    if: inputs.build_tool == 'Nuitka'
    uses: ./.github/workflows/Nuitka.yml
    with:
      version: ${{ inputs.version }}

  build-pyinstaller:
    if: inputs.build_tool == 'PyInstaller'
    uses: ./.github/workflows/PyInstaller.yml
    with:
      version: ${{ inputs.version }}

  release:
    needs: [build-pyappify, build-nuitka, build-pyinstaller]
    if: always() && (needs.build-pyappify.result == 'success' || needs.build-nuitka.result == 'success' || needs.build-pyinstaller.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Download PyAppify artifact
        if: inputs.build_tool == 'PyAppify'
        uses: actions/download-artifact@v4
        with:
          name: DUANJU-PyAppify-${{ inputs.version }}
          path: dist

      - name: Download Nuitka artifact
        if: inputs.build_tool == 'Nuitka'
        uses: actions/download-artifact@v4
        with:
          name: Duanju-Nuitka-${{ inputs.version }}
          path: dist

      - name: Download PyInstaller artifact
        if: inputs.build_tool == 'PyInstaller'
        uses: actions/download-artifact@v4
        with:
          name: Duanju-PyInstaller-${{ inputs.version }}
          path: dist

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: DUANJU v${{ inputs.version }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          body: |
            ## DUANJU 短剧播放器 v${{ inputs.version }}

            打包工具: ${{ inputs.build_tool }}

            ### 下载说明
            | 文件 | 说明 |
            |------|------|
            | `DUANJU-win32.zip` | 便携版，解压即用 |
            | `DUANJU-win32-release-setup.exe` | 完整安装包 |
            | `DUANJU-win32-online-setup.exe` | 在线安装包（体积小，需联网） |

            ### 使用方法
            1. 下载上述任一版本
            2. 便携版解压后运行 `DUANJU.exe`，安装版双击安装
            3. 首次启动会自动配置环境

            ### Termux (Android)
            ```bash
            curl -sL https://gitee.com/GamblerIX/DUANJU/raw/main/Termux/install.sh | bash
            ```

            ### Debug 版本
            Debug 版本请自行从源码运行：
            ```bash
            cd Debug
            pip install -r requirements.txt
            python main.py
            ```
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
